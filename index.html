<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebASRCore - 語音服務測試</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind CSS 配置 -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'spin': 'spin 1s linear infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideIn: {
                            '0%': { opacity: '0', transform: 'translateX(-20px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' }
                        }
                    },
                    height: {
                        'screen-90': '90vh',
                        'screen-85': '85vh',
                        'screen-80': '80vh'
                    }
                }
            }
        }
    </script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- 自定義樣式 -->
    <link rel="stylesheet" href="style.css">
</head>

<body class="h-screen bg-gradient-to-br from-purple-500 via-indigo-600 to-blue-700 overflow-hidden">
    <div class="h-full flex flex-col p-4 max-w-7xl mx-auto">
        <!-- 標題區域 - 固定高度 -->
        <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl p-4 mb-4 flex-shrink-0">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 flex items-center gap-3">
                <i class="fas fa-microphone-alt text-indigo-600"></i>
                WebASRCore 語音服務測試
            </h1>
        </div>

        <!-- 初始化區域 - 固定高度 -->
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl p-4 mb-4 flex-shrink-0 shadow-2xl">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
                <div class="flex items-center gap-3 text-white">
                    <i class="fas fa-box text-2xl"></i>
                    <h2 class="text-xl font-semibold">模型初始化</h2>
                </div>
                <button id="initBtn" class="px-6 py-2 bg-white text-indigo-600 font-semibold rounded-lg 
                               hover:bg-gray-100 transition-all duration-200 transform hover:scale-105
                               disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                    <i class="fas fa-download mr-2"></i>載入所有模型
                </button>
            </div>
            <div id="initStatus" class="mt-3 p-3 bg-white/20 backdrop-blur-sm rounded-lg text-white font-medium">
                點擊載入模型以開始測試
            </div>
            <div id="initLoading" class="hidden mt-3">
                <div class="flex items-center gap-3 text-white">
                    <div class="w-8 h-8 border-3 border-white/30 border-t-white rounded-full animate-spin"></div>
                    <span>正在載入模型...</span>
                </div>
            </div>
        </div>

        <!-- 服務測試區域 - 使用剩餘空間 -->
        <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-4 min-h-0">
            <!-- VAD 服務 -->
            <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl p-4 flex flex-col min-h-0 border-t-4 border-indigo-500">
                <!-- 標題區域 -->
                <div class="flex items-center justify-between mb-3 flex-shrink-0">
                    <h2 class="text-lg font-bold text-indigo-700 flex items-center gap-2">
                        <i class="fas fa-wave-square text-xl"></i>
                        VAD 檢測
                    </h2>
                </div>

                <!-- 控制區域 - 統一高度 -->
                <div class="flex gap-2 mb-3 flex-shrink-0 h-9">
                    <button id="vadStartBtn"
                        class="px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg font-medium
                                   hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-play mr-1"></i>開始
                    </button>
                    <button id="vadStopBtn"
                        class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg font-medium
                                   hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-stop mr-1"></i>停止
                    </button>
                    <!-- 空白區域保持對齊 -->
                    <div class="flex-1"></div>
                </div>

                <canvas id="vadCanvas" class="w-full h-16 bg-gray-800 rounded-lg mb-3 flex-shrink-0"></canvas>

                <div id="vadStatus"
                    class="px-3 py-2 bg-indigo-50 rounded-lg border-l-4 border-indigo-400 text-sm font-medium mb-3 text-indigo-800 flex-shrink-0">
                    等待模型載入...
                </div>

                <!-- log 區域使用剩餘空間並可滾動 -->
                <div class="flex-1 bg-gray-900 rounded-lg p-3 min-h-0">
                    <div id="vadLog" class="h-full overflow-y-auto custom-scrollbar text-gray-200 font-mono text-xs space-y-1">
                    </div>
                </div>
            </div>

            <!-- 喚醒詞服務 -->
            <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl p-4 flex flex-col min-h-0 border-t-4 border-purple-500">
                <!-- 標題區域 -->
                <div class="flex items-center justify-between mb-3 flex-shrink-0">
                    <h2 class="text-lg font-bold text-purple-700 flex items-center gap-2">
                        <i class="fas fa-bell text-xl"></i>
                        喚醒詞
                    </h2>
                </div>

                <!-- 控制區域 - 統一高度 -->
                <div class="flex gap-2 mb-3 flex-shrink-0 h-9">
                    <button id="wakewordStartBtn"
                        class="px-3 py-1.5 bg-purple-600 text-white text-sm rounded-lg font-medium
                                   hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-play mr-1"></i>開始
                    </button>
                    <button id="wakewordStopBtn"
                        class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg font-medium
                                   hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-stop mr-1"></i>停止
                    </button>
                    <!-- 下拉選單放在控制區域右側 -->
                    <select id="wakewordSelect" class="ml-auto px-3 py-1.5 text-sm border border-purple-300 rounded-lg font-medium
                                   focus:outline-none focus:ring-2 focus:ring-purple-400" disabled>
                        <option value="hey-jarvis">Hey Jarvis</option>
                        <option value="hey-mycroft">Hey Mycroft</option>
                        <option value="alexa">Alexa</option>
                    </select>
                </div>

                <canvas id="wakewordCanvas" class="w-full h-16 bg-gray-800 rounded-lg mb-3 flex-shrink-0"></canvas>

                <div id="wakewordStatus"
                    class="px-3 py-2 bg-purple-50 rounded-lg border-l-4 border-purple-400 text-sm font-medium mb-3 text-purple-800 flex-shrink-0">
                    等待模型載入...
                </div>

                <!-- log 區域使用剩餘空間並可滾動 -->
                <div class="flex-1 bg-gray-900 rounded-lg p-3 min-h-0">
                    <div id="wakewordLog" class="h-full overflow-y-auto custom-scrollbar text-gray-200 font-mono text-xs space-y-1">
                    </div>
                </div>
            </div>

            <!-- Whisper 服務 -->
            <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl p-4 flex flex-col min-h-0 border-t-4 border-green-500">
                <!-- 標題區域 -->
                <div class="flex items-center justify-between mb-3 flex-shrink-0">
                    <h2 class="text-lg font-bold text-green-700 flex items-center gap-2">
                        <i class="fas fa-closed-captioning text-xl"></i>
                        Whisper
                    </h2>
                </div>

                <!-- 控制區域 - 統一高度 -->
                <div class="flex gap-2 mb-3 flex-shrink-0 h-9">
                    <button id="whisperRecordBtn"
                        class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg font-medium
                                   hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-microphone mr-1"></i>錄音
                    </button>
                    <button id="whisperStopBtn"
                        class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg font-medium
                                   hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed hidden" disabled>
                        <i class="fas fa-stop mr-1"></i>停止
                    </button>
                    <button id="whisperTranscribeBtn"
                        class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg font-medium
                                   hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-language mr-1"></i>轉譯
                    </button>
                    <!-- 空白區域保持對齊 -->
                    <div class="flex-1"></div>
                </div>

                <canvas id="whisperCanvas" class="w-full h-16 bg-gray-800 rounded-lg mb-3 flex-shrink-0"></canvas>

                <div id="whisperStatus"
                    class="px-3 py-2 bg-green-50 rounded-lg border-l-4 border-green-400 text-sm font-medium mb-3 text-green-800 flex-shrink-0">
                    等待模型載入...
                </div>

                <!-- log 區域使用剩餘空間並可滾動 -->
                <div class="flex-1 bg-gray-900 rounded-lg p-3 min-h-0">
                    <div id="whisperLog" class="h-full overflow-y-auto custom-scrollbar text-gray-200 font-mono text-xs space-y-1">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 載入依賴庫 -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.16.3/dist/ort.min.js"></script> -->
    <script>
        // 設定 ONNX Runtime WASM 路徑
        if (window.ort) {
            ort.env.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/';
            console.log('ONNX Runtime Web 已載入，版本:', ort.env.versions.web);
        }
    </script>
    
    <script type="module">
        // 動態載入 transformers.js
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

        // 設定 transformers.js 環境
        env.allowLocalModels = true;
        env.allowRemoteModels = false;  // 禁止從 HuggingFace 下載
        env.localModelPath = '../models/huggingface/';  // 設定本地模型基礎路徑
        
        // 設定 WASM 路徑
        env.backends = env.backends || {};
        env.backends.onnx = env.backends.onnx || {};
        env.backends.onnx.wasm = env.backends.onnx.wasm || {};
        env.backends.onnx.wasm.wasmPaths = 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/';
        
        // 將 transformers 加到全域供 WebASRCore 使用
        window.transformers = { pipeline, env };
        console.log('Transformers.js 已載入');
    </script>

    <!-- 主程式 -->
    <script type="module" src="script.js"></script>
</body>

</html>