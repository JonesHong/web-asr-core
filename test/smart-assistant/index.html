<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧語音助手 - WebASRCore v0.8.1</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom Styles (Warm Neutrals Theme) -->
    <style>
        :root{
            --bg:#FAF7F2;
            --text:#2F2A24;
            --cream:#EED9C4;
            --butter:#F6E27D;
            --sage:#A3B18A;
        }

        body{
            background: linear-gradient(135deg, var(--bg), var(--cream));
            color: var(--text);
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(246, 226, 125, 0.55); }
            50% { transform: scale(1); box-shadow: 0 0 0 20px rgba(246, 226, 125, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(246, 226, 125, 0); }
        }
        .listening-animation { animation: pulse-ring 2s infinite; }
        .state-indicator { transition: all 0.3s ease; }

        .sound-wave{ display:flex; align-items:center; gap:4px; height:40px; }
        .sound-wave span{
            display:inline-block; width:4px; height:100%;
            background: linear-gradient(180deg, var(--sage), var(--butter));
            border-radius:2px; animation: wave 0.8s ease-in-out infinite;
        }
        .sound-wave span:nth-child(1){ animation-delay:0s; }
        .sound-wave span:nth-child(2){ animation-delay:0.1s; }
        .sound-wave span:nth-child(3){ animation-delay:0.2s; }
        .sound-wave span:nth-child(4){ animation-delay:0.3s; }
        .sound-wave span:nth-child(5){ animation-delay:0.4s; }

        @keyframes wave{
            0%,100%{ transform: scaleY(0.3); opacity: .55; }
            50%{ transform: scaleY(1); opacity: 1; }
        }

        .timer-progress{ transition: width 1s linear; }

        .state-idle{
            background: linear-gradient(135deg, var(--cream), var(--bg));
            color: var(--text);
        }
        .state-listening{
            background: linear-gradient(135deg, var(--sage), var(--butter));
            color: var(--text);
        }
        .state-processing{
            background: linear-gradient(135deg, var(--butter), var(--cream));
            color: var(--text);
        }

        .custom-scrollbar::-webkit-scrollbar{ width:6px; height:6px; }
        .custom-scrollbar::-webkit-scrollbar-track{ background: rgba(0,0,0,.06); border-radius:3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb{ background: rgba(47,42,36,.25); border-radius:3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover{ background: rgba(47,42,36,.4); }

        .card-hover { transition: transform 0.2s, box-shadow 0.2s; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="h-screen overflow-hidden">
    <div class="container mx-auto px-4 py-2 max-w-6xl h-full flex flex-col">

        <!-- Header with Status Bar -->
        <div class="flex justify-between items-start mb-3 flex-shrink-0">
            <div>
                <h1 class="text-2xl font-bold text-[var(--text)]">
                    <i class="fas fa-robot mr-2 text-xl"></i>
                    智慧語音助手
                </h1>
                <p class="text-[color:var(--text)]/70 text-xs">WebASRCore v0.8.1</p>
            </div>

            <div class="bg-white/95 backdrop-blur-sm rounded-lg shadow px-3 py-2 min-w-[380px]">
                <div class="grid grid-cols-4 gap-3 text-center">
                    <div>
                        <div class="text-xs text-[color:var(--text)]/60">VAD</div>
                        <div id="vadStatus" class="text-xs font-semibold text-[var(--text)]">
                            <i class="fas fa-circle text-[color:var(--text)]/30 mr-1 text-[8px]"></i>未初始化
                        </div>
                    </div>
                    <div>
                        <div class="text-xs text-[color:var(--text)]/60">喚醒詞</div>
                        <div id="wakewordStatus" class="text-xs font-semibold text-[var(--text)]">
                            <i class="fas fa-circle text-[color:var(--text)]/30 mr-1 text-[8px]"></i>未初始化
                        </div>
                    </div>
                    <div>
                        <div class="text-xs text-[color:var(--text)]/60">STT</div>
                        <div id="sttStatus" class="text-xs font-semibold text-[var(--text)]">
                            <i class="fas fa-circle text-[color:var(--text)]/30 mr-1 text-[8px]"></i>未初始化
                        </div>
                    </div>
                    <div>
                        <div class="text-xs text-[color:var(--text)]/60">WebGPU</div>
                        <div id="webgpuStatus" class="text-xs font-semibold text-[var(--text)]">
                            <i class="fas fa-circle text-[color:var(--text)]/30 mr-1 text-[8px]"></i>檢測中
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid lg:grid-cols-12 gap-3 flex-1 overflow-hidden min-h-0">

            <!-- Left Column: Assistant Status + Settings + Timer -->
            <div class="lg:col-span-3 space-y-3 h-full overflow-y-auto custom-scrollbar">
                <!-- Status Card -->
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-3 card-hover">
                    <h2 class="text-base font-semibold text-[var(--text)] mb-2">
                        <i class="fas fa-info-circle mr-1 text-sm"></i>助手狀態
                    </h2>

                    <div class="mb-3">
                        <div id="stateIndicator" class="state-indicator state-idle rounded-full w-20 h-20 mx-auto flex items-center justify-center shadow-lg">
                            <div class="text-center">
                                <i id="stateIcon" class="fas fa-bed text-2xl mb-1"></i>
                                <div id="stateText" class="text-xs font-semibold">閒置中</div>
                            </div>
                        </div>
                    </div>

                    <div id="soundWave" class="sound-wave justify-center mb-3 hidden">
                        <span></span><span></span><span></span><span></span><span></span>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button id="wakeBtn" class="px-3 py-2 bg-[var(--sage)] text-[var(--text)] rounded-lg text-sm font-semibold hover:shadow-lg transform hover:scale-105 transition-all">
                            <i class="fas fa-power-off mr-1"></i>喚醒
                        </button>
                        <button id="sleepBtn" class="px-3 py-2 bg-[var(--cream)] text-[var(--text)] rounded-lg text-sm font-semibold hover:shadow-lg transform hover:scale-105 transition-all">
                            <i class="fas fa-moon mr-1"></i>休眠
                        </button>
                    </div>
                </div>

                <!-- Settings Card -->
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-3 card-hover">
                    <h3 class="text-sm font-semibold text-[var(--text)] mb-2">
                        <i class="fas fa-cog mr-1 text-xs"></i>設定
                    </h3>

                    <div class="mb-3">
                        <label class="text-sm text-[color:var(--text)]/70 mb-1 block">VAD 敏感度</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="vadThreshold" min="0.1" max="0.9" step="0.1" value="0.5" class="flex-1">
                            <span id="vadThresholdValue" class="text-sm text-[var(--text)] w-8">0.5</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="text-sm text-[color:var(--text)]/70 mb-1 block">喚醒詞敏感度</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="wakewordThreshold" min="0.1" max="0.9" step="0.1" value="0.6" class="flex-1">
                            <span id="wakewordThresholdValue" class="text-sm text-[var(--text)] w-8">0.6</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="text-sm text-[color:var(--text)]/70 mb-1 block">靜音超時 (秒)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="silenceTimeout" min="1" max="5" step="0.1" value="1.8" class="flex-1">
                            <span id="silenceTimeoutValue" class="text-sm text-[var(--text)] w-8">1.8</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="text-sm text-[color:var(--text)]/70 mb-1 block">喚醒詞模型</label>
                        <select id="wakewordModel" class="w-full px-3 py-2 border border-[color:var(--text)]/20 rounded-lg text-sm bg-white">
                            <option value="hey-jarvis">Hey Jarvis</option>
                            <option value="alexa">Alexa</option>
                            <option value="hey-mycroft">Hey Mycroft</option>
                            <option value="custom">自訂模型</option>
                        </select>
                    </div>

                    <div id="customModelSection" class="hidden">
                        <input type="file" id="customModelInput" accept=".onnx" class="hidden">
                        <button id="uploadModelBtn" class="w-full px-4 py-2 bg-[var(--butter)] text-[var(--text)] rounded-lg text-sm hover:brightness-95 transition-colors">
                            <i class="fas fa-upload mr-2"></i>上傳自訂模型
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="text-sm text-[color:var(--text)]/70 mb-1 block">TTS 語音</label>
                        <select id="ttsVoiceSelect" class="w-full px-3 py-2 border border-[color:var(--text)]/20 rounded-lg text-sm bg-white">
                            <option value="">預設語音</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="text-sm text-[color:var(--text)]/70 mb-1 block">TTS 速度</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="ttsRateSlider" min="0.5" max="2" step="0.1" value="1.8" class="flex-1">
                            <span id="ttsRateValue" class="text-sm text-[var(--text)] w-8">1.8</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="text-sm text-[color:var(--text)]/70 mb-1 block">TTS 音調</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="ttsPitchSlider" min="0.5" max="2" step="0.1" value="1" class="flex-1">
                            <span id="ttsPitchValue" class="text-sm text-[var(--text)] w-8">1.0</span>
                        </div>
                    </div>
                </div>

                <!-- (Moved) Timer Card -->
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-3 card-hover">
                    <h3 class="text-base font-semibold text-[var(--text)] mb-3">
                        <i class="fas fa-stopwatch mr-2"></i>計時器狀態
                    </h3>

                    <div class="mb-3">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-[color:var(--text)]/70">靜音計時器</span>
                            <span id="silenceTimerDisplay" class="text-[var(--text)] font-mono">0.0s</span>
                        </div>
                        <div class="w-full h-2 bg-[color:var(--text)]/10 rounded-full overflow-hidden">
                            <div id="silenceTimerProgress" class="timer-progress h-full bg-gradient-to-r from-[var(--sage)] to-[var(--butter)] rounded-full" style="width:0%"></div>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-[color:var(--text)]/70">最大聆聽時間</span>
                            <span id="maxTimerDisplay" class="text-[var(--text)] font-mono">0.0s</span>
                        </div>
                        <div class="w-full h-2 bg-[color:var(--text)]/10 rounded-full overflow-hidden">
                            <div id="maxTimerProgress" class="timer-progress h-full bg-gradient-to-r from-[var(--cream)] to-[var(--butter)] rounded-full" style="width:0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Column: (top) Visualization, (bottom) Transcript filling rest -->
            <div class="lg:col-span-5 h-full flex flex-col gap-3 min-h-0">
                <!-- (Swapped) Audio Visualization on top -->
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-3 card-hover">
                    <h3 class="text-base font-semibold text-[var(--text)] mb-3">
                        <i class="fas fa-chart-line mr-2"></i>音訊視覺化
                    </h3>
                    <canvas id="audioCanvas" class="w-full h-28 bg-[var(--text)] rounded-lg"></canvas>
                </div>

                <!-- Transcript Card fills remaining height -->
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-4 card-hover flex flex-col flex-1 min-h-0">
                    <h3 class="text-base font-semibold text-[var(--text)] mb-3">
                        <i class="fas fa-closed-captioning mr-2"></i>識別結果
                    </h3>

                    <!-- Current Recognition (small, non-flex) -->
                    <div class="mb-3">
                        <div class="text-sm text-[color:var(--text)]/70 mb-1">即時識別：</div>
                        <div id="interimTranscript" class="min-h-[50px] p-3 bg-[var(--bg)] rounded-lg text-[color:var(--text)] italic">
                            等待語音輸入...
                        </div>
                    </div>

                    <!-- Final Recognition (fills remaining height, scrolls inside) -->
                    <div class="flex-1 min-h-0 flex flex-col">
                        <div class="text-sm text-[color:var(--text)]/70 mb-1">最終結果：</div>
                        <div id="finalTranscript" class="flex-1 min-h-0 overflow-y-auto custom-scrollbar p-3 bg-[var(--cream)] rounded-lg text-[color:var(--text)] text-sm">
                            尚未有識別結果
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Event Logs -->
            <div class="lg:col-span-4 h-full overflow-hidden">
                <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-3 h-full flex flex-col min-h-0 card-hover">
                    <!-- Sticky header without extra bottom margin -->
                    <div class="flex justify-between items-center mb-0 flex-shrink-0 sticky top-0 z-10 bg-white/95 backdrop-blur-sm px-2 py-2">
                        <h3 class="text-base font-semibold text-[var(--text)]">
                            <i class="fas fa-list mr-2"></i>事件日誌
                        </h3>
                        <button id="clearLogBtn" class="text-[color:var(--text)]/60 hover:text-[color:var(--text)] text-sm">
                            <i class="fas fa-trash mr-1"></i>清除
                        </button>
                    </div>

                    <!-- Log container: no top gap, wraps long text -->
                    <div id="eventLog" class="flex-1 min-h-0 overflow-y-auto overflow-x-hidden custom-scrollbar
                                               space-y-2 p-2 pt-0 bg-[var(--bg)] rounded-lg
                                               break-words whitespace-pre-wrap">
                        <!-- Event logs will appear here -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Load WebASRCore v0.8.1 from CDN -->
    <script src="https://unpkg.com/web-asr-core@0.8.1/dist/web-asr-core.min.js"></script>

    <!-- Application Modules -->
    <script src="ui.js"></script>
    <script src="assistant.js"></script>
    <script src="script.js"></script>
</body>
</html>
