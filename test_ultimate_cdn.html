<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebASRCore ULTIMATE ç‰ˆæœ¬æ¸¬è©¦ - å–®ä¸€ Script æ¨™ç±¤</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .highlight {
            background: #f0f0ff;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .control-panel {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Cascadia Code', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid transparent;
        }
        .info {
            color: #58a6ff;
            border-left-color: #58a6ff;
        }
        .success {
            color: #56d364;
            border-left-color: #56d364;
        }
        .warning {
            color: #f0883e;
            border-left-color: #f0883e;
        }
        .error {
            color: #f85149;
            border-left-color: #f85149;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .status-item {
            display: flex;
            align-items: center;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ready {
            background: #56d364;
        }
        .status-loading {
            background: #f0883e;
            animation: pulse 1.5s infinite;
        }
        .status-error {
            background: #f85149;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ WebASRCore ULTIMATE ç‰ˆæœ¬æ¸¬è©¦</h1>
        <p class="subtitle">åªéœ€è¦ <span class="highlight">&lt;script&gt;</span> æ¨™ç±¤ - åŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼</p>

        <div class="status-bar">
            <div class="status-item">
                <div id="coreStatus" class="status-indicator status-loading"></div>
                <span>WebASRCore: <span id="coreText">è¼‰å…¥ä¸­...</span></span>
            </div>
            <div class="status-item">
                <div id="transformersStatus" class="status-indicator status-loading"></div>
                <span>Transformers.js: <span id="transformersText">ç­‰å¾…ä¸­...</span></span>
            </div>
            <div class="status-item">
                <div id="ortStatus" class="status-indicator status-loading"></div>
                <span>ONNX Runtime: <span id="ortText">ç­‰å¾…ä¸­...</span></span>
            </div>
        </div>

        <div class="control-panel">
            <h3>åŠŸèƒ½æ¸¬è©¦</h3>
            <button id="testVadBtn">æ¸¬è©¦ VAD</button>
            <button id="testWakewordBtn">æ¸¬è©¦å–šé†’è©</button>
            <button id="initWhisperBtn">åˆå§‹åŒ– Whisper</button>
            <button id="recordBtn" disabled>é–‹å§‹éŒ„éŸ³</button>
            <button id="stopBtn" disabled>åœæ­¢éŒ„éŸ³</button>
            <button id="transcribeBtn" disabled>è½‰è­¯æ–‡å­—</button>
        </div>

        <div id="log"></div>
    </div>

    <!-- åªéœ€è¦é€™ä¸€å€‹ script æ¨™ç±¤ï¼ -->
    <script src="dist/web-asr-core.ultimate.min.js"></script>

    <script>
        // æ—¥èªŒåŠŸèƒ½
        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${time}] ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, msg);
        }

        // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateStatus(id, status, text) {
            const indicator = document.getElementById(id + 'Status');
            const textElem = document.getElementById(id + 'Text');

            indicator.className = 'status-indicator';
            if (status === 'ready') {
                indicator.classList.add('status-ready');
            } else if (status === 'loading') {
                indicator.classList.add('status-loading');
            } else if (status === 'error') {
                indicator.classList.add('status-error');
            }

            textElem.textContent = text;
        }

        // å…¨åŸŸè®Šæ•¸
        let whisperService = null;
        let audioData = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // åˆå§‹åŒ–æª¢æŸ¥
        log('ğŸš€ ULTIMATE ç‰ˆæœ¬è¼‰å…¥æ¸¬è©¦é–‹å§‹', 'info');
        log('é€™å€‹ç‰ˆæœ¬åªéœ€è¦ä¸€å€‹ script æ¨™ç±¤å°±èƒ½ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ï¼', 'success');

        // æª¢æŸ¥è¼‰å…¥ç‹€æ…‹
        setTimeout(() => {
            // æª¢æŸ¥ WebASRCore
            if (window.WebASRCore) {
                updateStatus('core', 'ready', 'å·²è¼‰å…¥');
                log('âœ… WebASRCore å·²è¼‰å…¥', 'success');
                const services = Object.keys(window.WebASRCore).filter(k => k.includes('Service'));
                log(`å¯ç”¨æœå‹™: ${services.join(', ')}`, 'info');
            } else {
                updateStatus('core', 'error', 'æœªè¼‰å…¥');
                log('âŒ WebASRCore æœªè¼‰å…¥', 'error');
            }

            // æª¢æŸ¥ Transformers.js
            if (window.transformers) {
                updateStatus('transformers', 'ready', 'å·²è¼‰å…¥');
                log('âœ… Transformers.js å·²è‡ªå‹•è¼‰å…¥ä¸¦é…ç½®', 'success');
                log(`ç’°å¢ƒé…ç½®: WASMè·¯å¾‘=${window.transformers.env.backends?.onnx?.wasm?.wasmPaths || 'æœªè¨­å®š'}`, 'info');
            } else {
                updateStatus('transformers', 'error', 'æœªè¼‰å…¥');
                log('âš ï¸ Transformers.js æœªè¼‰å…¥ï¼ˆWhisper åŠŸèƒ½å°‡ä¸å¯ç”¨ï¼‰', 'warning');
            }

            // æª¢æŸ¥ ONNX Runtime
            if (window.ort) {
                updateStatus('ort', 'ready', 'å·²è¼‰å…¥');
                log('âœ… ONNX Runtime å·²è¼‰å…¥', 'success');
            } else {
                updateStatus('ort', 'error', 'æœªè¼‰å…¥');
                log('âš ï¸ ONNX Runtime æœªè¼‰å…¥', 'warning');
            }
        }, 1000);

        // æ¸¬è©¦ VAD
        document.getElementById('testVadBtn').addEventListener('click', async () => {
            try {
                log('æ¸¬è©¦ VAD æœå‹™...', 'info');
                const vadService = new WebASRCore.VadService();
                await vadService.initialize();
                log('âœ… VAD æœå‹™åˆå§‹åŒ–æˆåŠŸï¼', 'success');

                // å‰µå»ºæ¸¬è©¦éŸ³è¨Š
                const testAudio = new Float32Array(512).fill(0);
                const result = await vadService.processAudio(testAudio);
                log(`VAD æ¸¬è©¦çµæœ: èªéŸ³=${result.isSpeech}, åˆ†æ•¸=${result.score.toFixed(3)}`, 'info');
            } catch (error) {
                log(`âŒ VAD æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        });

        // æ¸¬è©¦å–šé†’è©
        document.getElementById('testWakewordBtn').addEventListener('click', async () => {
            try {
                log('æ¸¬è©¦å–šé†’è©æœå‹™...', 'info');
                const wakewordService = new WebASRCore.WakewordService();
                await wakewordService.initialize('hey-jarvis');
                log('âœ… å–šé†’è©æœå‹™åˆå§‹åŒ–æˆåŠŸï¼ˆHey Jarvisï¼‰ï¼', 'success');

                // å‰µå»ºæ¸¬è©¦éŸ³è¨Š
                const testAudio = new Float32Array(1280).fill(0);
                const result = await wakewordService.processAudio(testAudio);
                log(`å–šé†’è©æ¸¬è©¦çµæœ: æª¢æ¸¬=${result.detected}`, 'info');
            } catch (error) {
                log(`âŒ å–šé†’è©æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
            }
        });

        // åˆå§‹åŒ– Whisper
        document.getElementById('initWhisperBtn').addEventListener('click', async () => {
            const btn = document.getElementById('initWhisperBtn');
            btn.disabled = true;

            try {
                if (!window.transformers) {
                    throw new Error('Transformers.js æœªè¼‰å…¥');
                }

                log('åˆå§‹åŒ– Whisper æœå‹™...', 'info');
                whisperService = new WebASRCore.WhisperService({
                    language: 'zh',
                    temperature: 0.8
                });

                // äº‹ä»¶ç›£è½
                whisperService.on('ready', (e) => {
                    log(`âœ… Whisper æ¨¡å‹å·²å°±ç·’: ${e.modelId}`, 'success');
                    document.getElementById('recordBtn').disabled = false;
                });

                whisperService.on('error', (e) => {
                    log(`âŒ Whisper éŒ¯èª¤: ${e.error.message}`, 'error');
                });

                // åˆå§‹åŒ–æ¨¡å‹
                log('è¼‰å…¥ Whisper æ¨¡å‹ (é¦–æ¬¡éœ€è¦ä¸‹è¼‰ï¼Œè«‹è€å¿ƒç­‰å¾…)...', 'warning');
                await whisperService.initialize('Xenova/whisper-tiny', {
                    quantized: true,
                    device: 'wasm'
                });

                log('âœ… Whisper åˆå§‹åŒ–å®Œæˆï¼å¯ä»¥é–‹å§‹éŒ„éŸ³äº†', 'success');

            } catch (error) {
                log(`âŒ Whisper åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                btn.disabled = false;
            }
        });

        // éŒ„éŸ³åŠŸèƒ½
        document.getElementById('recordBtn').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const audioContext = new AudioContext({ sampleRate: 16000 });
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    audioData = audioBuffer.getChannelData(0);

                    const duration = (audioData.length / 16000).toFixed(1);
                    log(`éŒ„éŸ³å®Œæˆ: ${duration} ç§’`, 'success');
                    document.getElementById('transcribeBtn').disabled = false;
                };

                mediaRecorder.start();
                log('ğŸ”´ éŒ„éŸ³ä¸­...', 'warning');

                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;

            } catch (error) {
                log(`éŒ„éŸ³å¤±æ•—: ${error.message}`, 'error');
            }
        });

        // åœæ­¢éŒ„éŸ³
        document.getElementById('stopBtn').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());

                document.getElementById('stopBtn').disabled = true;
                document.getElementById('recordBtn').disabled = false;
                log('éŒ„éŸ³å·²åœæ­¢', 'info');
            }
        });

        // è½‰è­¯åŠŸèƒ½
        document.getElementById('transcribeBtn').addEventListener('click', async () => {
            if (!audioData || !whisperService) {
                log('ç„¡éŸ³è¨Šè³‡æ–™æˆ–æœå‹™æœªåˆå§‹åŒ–', 'error');
                return;
            }

            const btn = document.getElementById('transcribeBtn');
            btn.disabled = true;

            try {
                log('é–‹å§‹è½‰è­¯...', 'info');
                const start = Date.now();

                const result = await whisperService.transcribe(audioData);

                const elapsed = ((Date.now() - start) / 1000).toFixed(1);
                log(`âœ… è½‰è­¯å®Œæˆ (${elapsed}ç§’)`, 'success');
                log(`ğŸ“ çµæœ: "${result.text}"`, 'success');

            } catch (error) {
                log(`è½‰è­¯å¤±æ•—: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        });

        // é é¢è¼‰å…¥å®Œæˆæç¤º
        window.addEventListener('load', () => {
            log('');
            log('ğŸ“Œ ä½¿ç”¨èªªæ˜:', 'info');
            log('1. é»æ“Šã€Œæ¸¬è©¦ VADã€æˆ–ã€Œæ¸¬è©¦å–šé†’è©ã€ä¾†æ¸¬è©¦åŸºæœ¬åŠŸèƒ½', 'info');
            log('2. é»æ“Šã€Œåˆå§‹åŒ– Whisperã€ä¾†è¼‰å…¥èªéŸ³è½‰æ–‡å­—æ¨¡å‹', 'info');
            log('3. åˆå§‹åŒ–å®Œæˆå¾Œå¯ä»¥éŒ„éŸ³ä¸¦è½‰è­¯', 'info');
            log('');
            log('ğŸ’¡ é€™å€‹ç‰ˆæœ¬åªéœ€è¦ä¸€å€‹ script æ¨™ç±¤å°±åŒ…å«äº†æ‰€æœ‰åŠŸèƒ½ï¼', 'success');
        });
    </script>
</body>
</html>